**Транспортный уровень** модели OSI (и транспортный уровень в модели TCP/IP) отвечает за передачу данных между хостами, обеспечивая различную степень надёжности и управление соединением. Основные протоколы этого уровня — **протокол управления передачей (Transmission Control Protocol, TCP)** и **протокол пользовательских датаграмм (User Datagram Protocol, UDP)**. Этот конспект описывает их особенности, механизмы работы, а также понятия портов и сокетов.

---

## Протокол управления передачей (TCP): Надёжность

**TCP** — это надёжный, ориентированный на соединение протокол транспортного уровня, который гарантирует доставку данных без потерь, в правильном порядке и с управлением потоком.

### Особенности TCP

- **Надёжность**:
  - Подтверждение доставки (ACK): Получатель отправляет подтверждение для каждого сегмента.
  - Повторная передача: Если сегмент потерян, отправитель повторяет его.
- **Управление порядком**:
  - Сегменты нумеруются, чтобы собрать данные в правильной последовательности.
- **Трехэтапное рукопожатие (Three-Way Handshake)**:
  - Устанавливает соединение перед передачей данных:
    1. Клиент отправляет SYN (synchronize).
    2. Сервер отвечает SYN-ACK (synchronize-acknowledgment).
    3. Клиент отправляет ACK (acknowledgment).
- **Управление потоком**:
  - Использует "скользящее окно" (sliding window), чтобы регулировать объём данных, отправляемых без подтверждения.
- **Обработка ошибок**:
  - Контрольные суммы выявляют повреждённые сегменты.

### Применение

- Веб (HTTP/HTTPS).
- Электронная почта (SMTP, IMAP).
- Передача файлов (FTP).
- Базы данных (SQL-запросы).

**Пример**: При загрузке веб-страницы TCP разбивает HTTP-запрос на сегменты, доставляет их серверу и собирает ответ в правильном порядке.

---

## Протокол пользовательских датаграмм (UDP): Скорость против надёжности

**UDP** — это ненадёжный, неориентированный на соединение протокол, который жертвует надёжностью ради скорости и простоты.

### Особенности UDP

- **Отсутствие соединения**:
  - Нет рукопожатия, данные отправляются сразу (датаграммы).
- **Нет гарантий доставки**:
  - Датаграммы могут теряться, дублироваться или приходить в неправильном порядке.
- **Минимальный оверхед**:
  - Заголовок UDP (8 байт) меньше, чем у TCP (20 байт), что снижает задержки.
- **Нет управления потоком**:
  - Отправитель передаёт данные без учёта состояния получателя.
- **Проверка ошибок**:
  - Использует контрольную сумму, но не повторяет передачу при ошибке.

### Применение

- Потоковое видео и аудио (RTMP, RTP).
- Онлайн-игры, где важна низкая задержка.
- DNS-запросы.
- VoIP (видеозвонки, WebRTC).

**Пример**: В видеозвонке UDP передаёт аудио- и видеопоток, где потеря нескольких датаграмм не критична, но важна скорость.

---

## TCP vs UDP: Сравнение

|                        |                                          |                                   |
| ---------------------- | ---------------------------------------- | --------------------------------- |
| **Характеристика**     | **TCP**                                  | **UDP**                           |
| **Надёжность**         | Гарантирует доставку и порядок           | Нет гарантий доставки или порядка |
| **Соединение**         | Ориентирован на соединение (рукопожатие) | Без соединения                    |
| **Скорость**           | Медленнее из-за оверхеда                 | Быстрее, минимальный оверхед      |
| **Управление потоком** | Есть (скользящее окно)                   | Нет                               |
| **Применение**         | Веб, почта, файлы                        | Стриминг, игры, DNS               |

**Выбор протокола**:

- Используйте **TCP** для приложений, где важна надёжность (например, API).
- Используйте **UDP** для приложений, где важна скорость и допустимы потери (например, стриминг).

---

## Порты и сокеты: Как приложения общаются через сеть

### Порты

- **Порт** — 16-битное число (0–65535), которое идентифицирует конкретное приложение или службу на хосте.
- **Типы портов**:
  - **Системные** (0–1023): Зарезервированы для стандартных служб (HTTP — 80, HTTPS — 443, SSH — 22).
  - **Зарегистрированные** (1024–49151): Для пользовательских приложений.
  - **Динамические** (49152–65535): Для временных соединений (например, клиентские порты).
- **Роль портов**:
  - Позволяют нескольким приложениям на одном хосте использовать сеть одновременно.
  - IP-адрес + порт = уникальный идентификатор соединения.

**Пример**: Сервер с IP 192.168.1.1 принимает HTTP-запросы на порту 80 и SSH-соединения на порту 22.

### Сокеты

- **Сокет** — программный интерфейс, представляющий конечную точку сетевого соединения.
- Состоит из:
  - IP-адреса.
  - Порта.
  - Протокола (TCP или UDP).
- **Типы сокетов**:
  - **TCP-сокет**: Для надёжных соединений (например, HTTP).
  - **UDP-сокет**: Для датаграмм (например, DNS).
- **Как работают**:
  - Клиент создаёт сокет для соединения с сервером (например, 192.168.1.1:80).
  - Сервер слушает входящие соединения на сокете.

**Пример**: Веб-браузер создаёт TCP-сокет для соединения с сервером по адресу 142.250.190.78:443 для HTTPS-запроса.

---

## Значение для бэкенд-разработчиков

Понимание транспортного уровня и протоколов TCP/UDP важно для бэкенд-разработчиков по следующим причинам:

1. **Выбор протокола**:
   - Знание различий между TCP и UDP помогает выбирать подходящий протокол.
   - Пример: Использование TCP для REST API и UDP для потокового видео.

2. **Диагностика проблем**:
   - Ошибки на транспортном уровне (например, "Connection Refused") связаны с портами или протоколами.
   - Пример: Если порт 443 закрыт, HTTPS-соединение не установится.

3. **Оптимизация производительности**:
   - TCP-механизмы, такие как управление потоком, влияют на задержки.
   - Пример: Настройка размера окна TCP для повышения пропускной способности.

4. **Настройка серверов**:
   - Разработчики должны открывать нужные порты и настраивать сокеты.
   - Пример: Настройка Nginx для прослушивания порта 80.

5. **Безопасность**:
   - Понимание портов помогает защищать серверы.
   - Пример: Закрытие неиспользуемых портов для предотвращения атак.

**Пример для разработчика**: Если API отвечает медленно, разработчик может проверить, использует ли оно TCP (возможно, из-за перегрузки) или переключиться на UDP для менее критичных данных.

---

## Примечания

- **TCP**: Надёжный протокол для приложений, где важна целостность данных.
- **UDP**: Быстрый протокол для приложений, где важна низкая задержка.
- **Порты и сокеты**: Ключи к мультиплексированию и сетевому взаимодействию приложений.
- **Для разработчиков**: Знание транспортного уровня помогает проектировать, отлаживать и оптимизировать приложения.

# üì¨ –ü—Ä–æ—Ç–æ–∫–æ–ª—ã –æ—á–µ—Ä–µ–¥–µ–π: AMQP –∏ MQTT

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ó–∞—á–µ–º –Ω—É–∂–Ω—ã –æ—á–µ—Ä–µ–¥–∏?](#–∑–∞—á–µ–º-–Ω—É–∂–Ω—ã-–æ—á–µ—Ä–µ–¥–∏)
2. [AMQP: –¢—è–∂–µ–ª–∞—è –∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è (RabbitMQ)](#amqp)
3. [Exchange Types –≤ AMQP](#exchange-types-–≤-amqp)
4. [MQTT: –î–ª—è "—É–º–Ω—ã—Ö" –≤–µ—â–µ–π (IoT)](#mqtt)
5. [QoS —É—Ä–æ–≤–Ω–∏ –≤ MQTT](#qos-—É—Ä–æ–≤–Ω–∏-–≤-mqtt)
6. [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ –≤—ã–±–æ—Ä](#—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
7. [–ü—Ä–∏–º–µ—Ä—ã –Ω–∞ Go](#–ø—Ä–∏–º–µ—Ä—ã-–Ω–∞-go)

---

## ‚ùì –ó–∞—á–µ–º –Ω—É–∂–Ω—ã –æ—á–µ—Ä–µ–¥–∏?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —é–∑–µ—Ä–∞ –≤–∞–º –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Email. –ï—Å–ª–∏ —ç—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ –≤ –∫–æ–¥–µ ‚Äî —é–∑–µ—Ä –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –ø–æ—á—Ç–∞. 

**–ü—Ä–æ–±–ª–µ–º–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
```go
func RegisterUser(user User) error {
    db.Save(user)
    
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–¥–µ—Ç 2-3 —Å–µ–∫—É–Ω–¥—ã!
    email.Send(user.Email, "Welcome!")
    
    return nil
}
```

**–†–µ—à–µ–Ω–∏–µ —Å –æ—á–µ—Ä–µ–¥—å—é:** üì•
```go
func RegisterUser(user User) error {
    db.Save(user)
    
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –∫–ª–∞–¥–µ–º –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å
    queue.Publish("send-email", user.Email)
    
    // –°—Ä–∞–∑—É –æ—Ç–≤–µ—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É
    return nil
}

// –û—Ç–¥–µ–ª—å–Ω—ã–π worker –∑–∞–±–∏—Ä–∞–µ—Ç –∑–∞–¥–∞—á–∏
func EmailWorker() {
    for task := range queue.Consume("send-email") {
        email.Send(task.Email, "Welcome!")
        task.Ack() // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    }
}
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ—á–µ—Ä–µ–¥–µ–π:

‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ï—Å–ª–∏ worker —É–ø–∞–ª, –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ workers  
‚úÖ **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è**: –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫

---

## üê∞ AMQP (Advanced Message Queuing Protocol)

–≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è **RabbitMQ**. –û–Ω —Å–ª–æ–∂–Ω—ã–π, –Ω–∞–¥–µ–∂–Ω—ã–π –∏ –≥–∏–±–∫–∏–π. üõ°Ô∏è

### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è:

- **Producer**: –°–æ–∑–¥–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- **Exchange (–û–±–º–µ–Ω–Ω–∏–∫)**: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
- **Queue (–û—á–µ—Ä–µ–¥—å)**: –•—Ä–∞–Ω–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **Consumer**: –ü–æ–ª—É—á–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- **Routing Key**: –ö–ª—é—á –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **Binding**: –°–≤—è–∑—å –º–µ–∂–¥—É Exchange –∏ Queue

```mermaid
flowchart LR
    P[Producer] -->|publish routing_key=error| Ex{Exchange}
    Ex -->|binding key=error| Q1[Error Queue]
    Ex -->|binding key=warning| Q2[Warning Queue]
    Ex -->|binding key=info| Q3[Info Queue]
    
    Q1 --> C1[Critical Alerts Worker]
    Q2 --> C2[Notification Worker]
    Q3 --> C3[Logger Worker]
```

### –ì–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏:

**Message Acknowledgment (Ack)**:
```go
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Ack (–æ–ø–∞—Å–Ω–æ!)
msgs, _ := ch.Consume("queue", "", true, ...)

// –†—É—á–Ω–æ–π Ack (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
msgs, _ := ch.Consume("queue", "", false, ...)
for msg := range msgs {
    err := processMessage(msg)
    if err != nil {
        msg.Nack(false, true) // Reject –∏ –≤–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
    } else {
        msg.Ack(false) // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —É—Å–ø–µ—à–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
    }
}
```

**Publisher Confirms**:
```go
ch.Confirm(false) // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π

ch.Publish("exchange", "routing.key", false, false, msg)

confirm := <-ch.NotifyPublish(make(chan amqp.Confirmation, 1))
if confirm.Ack {
    log.Println("Message delivered to broker")
} else {
    log.Println("Message lost!")
}
```

---

## üîÄ Exchange Types –≤ AMQP

Exchange –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, **–∫–∞–∫** —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ø–∞–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏.

### 1. Direct Exchange

–°–æ–æ–±—â–µ–Ω–∏–µ –∏–¥–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å, –µ—Å–ª–∏ **routing key** —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å **binding key**.

```mermaid
flowchart LR
    P[Producer] -->|"routing_key: error"| Ex{Direct Exchange}
    
    Ex -.->|"binding: info"| Q1[Info Queue]
    Ex ==>|"binding: error"| Q2[Error Queue]
    Ex -.->|"binding: warning"| Q3[Warning Queue]
```

**–ü—Ä–∏–º–µ—Ä –Ω–∞ Go:**
```go
// –°–æ–∑–¥–∞–µ–º exchange
ch.ExchangeDeclare(
    "logs_direct", // name
    "direct",      // type
    true,          // durable
    false,         // auto-delete
    false,         // internal
    false,         // no-wait
    nil,           // args
)

// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∫ exchange
ch.QueueBind(
    "error_queue",  // queue name
    "error",        // routing key
    "logs_direct",  // exchange
    false,
    nil,
)

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è
ch.Publish(
    "logs_direct", // exchange
    "error",       // routing key
    false,
    false,
    amqp.Publishing{
        ContentType: "text/plain",
        Body:        []byte("Database connection failed!"),
    },
)
```

---

### 2. Fanout Exchange

–°–æ–æ–±—â–µ–Ω–∏–µ –∏–¥–µ—Ç –≤–æ **–≤—Å–µ** –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ (broadcast). Routing key –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.

```mermaid
flowchart LR
    P[Producer] -->|"routing_key: ignored"| Ex{Fanout}
    
    Ex ==> Q1[Queue 1]
    Ex ==> Q2[Queue 2]
    Ex ==> Q3[Queue 3]
```

**Use case**: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º.

```go
ch.ExchangeDeclare("notifications", "fanout", true, false, false, false, nil)

// –ö–∞–∂–¥–∞—è –æ—á–µ—Ä–µ–¥—å –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
ch.QueueBind("email_queue", "", "notifications", false, nil)
ch.QueueBind("sms_queue", "", "notifications", false, nil)
ch.QueueBind("push_queue", "", "notifications", false, nil)

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è
ch.Publish("notifications", "", false, false, amqp.Publishing{
    Body: []byte("New product launched!"),
})
```

---

### 3. Topic Exchange

–°–æ–æ–±—â–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ **–ø–∞—Ç—Ç–µ—Ä–Ω–∞–º** routing key.

**Wildcards:**
- `*` ‚Äî –æ–¥–Ω–æ —Å–ª–æ–≤–æ
- `#` ‚Äî –Ω–æ–ª—å –∏–ª–∏ –±–æ–ª—å—à–µ —Å–ª–æ–≤

```mermaid
flowchart LR
    P[Producer] --> Ex{Topic Exchange}
    
    Ex -.->|"binding: user.#"| Q1["User Events Queue<br/>(user.created, user.deleted)"]
    Ex ==>|"binding: *.error"| Q2["All Errors Queue<br/>(user.error, payment.error)"]
    Ex -.->|"binding: payment.*"| Q3["Payment Queue<br/>(payment.success, payment.error)"]
    
    P -->|"routing: user.created"| Ex
```

**–ü—Ä–∏–º–µ—Ä—ã:**

| Routing Key | Binding Pattern | Match? |
|:---|:---|:---:|
| `user.created` | `user.*` | ‚úÖ |
| `user.profile.updated` | `user.*` | ‚ùå |
| `user.profile.updated` | `user.#` | ‚úÖ |
| `payment.error` | `*.error` | ‚úÖ |
| `system.critical.error` | `*.error` | ‚ùå |
| `system.critical.error` | `#.error` | ‚úÖ |

```go
ch.ExchangeDeclare("events", "topic", true, false, false, false, nil)

// –í—Å–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
ch.QueueBind("user_errors", "user.*.error", "events", false, nil)

// –í—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
ch.QueueBind("user_events", "user.#", "events", false, nil)

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è
ch.Publish("events", "user.auth.error", ...)
ch.Publish("events", "user.profile.updated", ...)
```

---

### 4. Headers Exchange

–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ **–∑–∞–≥–æ–ª–æ–≤–∫–∞–º** —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ routing key.

```go
ch.ExchangeDeclare("images", "headers", true, false, false, false, nil)

// –û—á–µ—Ä–µ–¥—å –¥–ª—è PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
ch.QueueBind("png_queue", "", "images", false, amqp.Table{
    "format": "png",
    "x-match": "all", // –í—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å
})

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è
ch.Publish("images", "", false, false, amqp.Publishing{
    Headers: amqp.Table{
        "format": "png",
        "size": "large",
    },
    Body: imageData,
})
```

---

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ Exchange Types

| Type | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ | Routing Key | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|:---|:---|:---:|:---:|
| **Direct** | –¢–æ—á–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è | –í–∞–∂–µ–Ω | ‚ö°‚ö°‚ö° |
| **Fanout** | Broadcast –≤—Å–µ–º | –ù–µ –≤–∞–∂–µ–Ω | ‚ö°‚ö°‚ö° |
| **Topic** | –ì–∏–±–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è | –ü–∞—Ç—Ç–µ—Ä–Ω—ã | ‚ö°‚ö° |
| **Headers** | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º | –ù–µ –≤–∞–∂–µ–Ω | ‚ö° |

---

## üì° MQTT (Message Queuing Telemetry Transport)

–õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —É—Å–ª–æ–≤–∏–π —Å –ø–ª–æ—Ö–∏–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –∏ —Å–ª–∞–±—ã–º –∂–µ–ª–µ–∑–æ–º. –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è **IoT** (—É–º–Ω—ã—Ö –¥–æ–º–æ–≤, –¥–∞—Ç—á–∏–∫–æ–≤). üí°

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:

- **Broker**: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Mosquitto, HiveMQ, EMQX)
- **Topic**: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–∏–ø–∞ `home/kitchen/temperature`
- **Publisher**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ topic
- **Subscriber**: –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ topic

```mermaid
flowchart TB
    subgraph Devices
        T1[Temperature Sensor]
        L1[Light Bulb]
        T2[Thermostat]
    end
    
    T1 -->|publish: home/temp| B{MQTT Broker}
    B -->|subscribe: home/temp| T2
    B -->|subscribe: home/#| App[Mobile App]
    
    App -->|publish: home/light/cmd| B
    B -->|subscribe: home/light/cmd| L1
```

### Topic Wildcards:

- **`+`** ‚Äî –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å: `home/+/temperature` ‚Üí `home/kitchen/temperature`, `home/bedroom/temperature`
- **`#`** ‚Äî –≤—Å–µ —É—Ä–æ–≤–Ω–∏: `home/#` ‚Üí `home/kitchen/temp`, `home/bedroom/light/status`

**–ü—Ä–∏–º–µ—Ä—ã:**

| Topic | –ü–æ–¥–ø–∏—Å–∫–∞ | Match? |
|:---|:---|:---:|
| `home/kitchen/temp` | `home/kitchen/temp` | ‚úÖ |
| `home/kitchen/temp` | `home/+/temp` | ‚úÖ |
| `home/kitchen/temp` | `home/#` | ‚úÖ |
| `home/kitchen/light` | `home/+/temp` | ‚ùå |
| `home/bedroom/sensor/temp` | `home/+/temp` | ‚ùå |
| `home/bedroom/sensor/temp` | `home/+/+/temp` | ‚úÖ |

---

## üéØ QoS —É—Ä–æ–≤–Ω–∏ –≤ MQTT

**QoS (Quality of Service)** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

### QoS 0: At Most Once (–ú–∞–∫—Å–∏–º—É–º —Ä–∞–∑)

- **–ì–∞—Ä–∞–Ω—Ç–∏—è**: –î–æ—Å—Ç–∞–≤–∫–∞ **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**
- **Fire and forget**: –û—Ç–ø—Ä–∞–≤–∏–ª –∏ –∑–∞–±—ã–ª
- **Overhead**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π
- **Use case**: –î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)

```
Publisher --> [Message] --> Broker --> [Message] --> Subscriber
```

> [!NOTE]
> –ï—Å–ª–∏ —Å–µ—Ç—å –ø—Ä–æ–ø–∞–ª–∞ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ **–ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è**.

---

### QoS 1: At Least Once (–ú–∏–Ω–∏–º—É–º —Ä–∞–∑)

- **–ì–∞—Ä–∞–Ω—Ç–∏—è**: –î–æ—Å—Ç–∞–≤–∫–∞ **–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**
- **–î—É–±–ª–∏–∫–∞—Ç—ã**: –í–æ–∑–º–æ–∂–Ω—ã
- **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: PUBACK
- **Use case**: –í–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–¥–∞—Ç—á–∏–∫ –¥—ã–º–∞ —Å—Ä–∞–±–æ—Ç–∞–ª)

```mermaid
sequenceDiagram
    participant P as Publisher
    participant B as Broker
    participant S as Subscriber
    
    P->>B: PUBLISH (QoS=1)
    B->>P: PUBACK
    
    B->>S: PUBLISH (QoS=1)
    S->>B: PUBACK
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ PUBACK –ø–æ—Ç–µ—Ä—è–ª—Å—è, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è **–¥–≤–∞–∂–¥—ã**.

---

### QoS 2: Exactly Once (–†–æ–≤–Ω–æ —Ä–∞–∑)

- **–ì–∞—Ä–∞–Ω—Ç–∏—è**: –î–æ—Å—Ç–∞–≤–∫–∞ **—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑**
- **–î—É–±–ª–∏–∫–∞—Ç—ã**: –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã
- **Overhead**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π (4-way handshake)
- **Use case**: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```mermaid
sequenceDiagram
    participant P as Publisher
    participant B as Broker
    
    P->>B: PUBLISH (QoS=2)
    B->>P: PUBREC
    P->>B: PUBREL
    B->>P: PUBCOMP
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ QoS:

| QoS | –î–æ—Å—Ç–∞–≤–∫–∞ | Overhead | –°—Ü–µ–Ω–∞—Ä–∏–π |
|:---:|:---|:---:|:---|
| **0** | 0 –∏–ª–∏ 1 —Ä–∞–∑ | ‚ö°‚ö°‚ö° | Streaming –¥–∞–Ω–Ω—ã—Ö |
| **1** | 1+ —Ä–∞–∑ | ‚ö°‚ö° | –°–æ–±—ã—Ç–∏—è, –ª–æ–≥–∏ |
| **2** | –†–æ–≤–Ω–æ 1 —Ä–∞–∑ | ‚ö° | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ–º–∞–Ω–¥—ã |

---

## üîî –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏—á–∏ MQTT

### Last Will and Testament (LWT)

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç **–≤–Ω–µ–∑–∞–ø–Ω–æ –æ—Ç–∫–ª—é—á–∏–ª—Å—è**, broker –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

```go
opts := mqtt.NewClientOptions()
opts.SetWill(
    "devices/sensor1/status",  // topic
    "offline",                  // message
    1,                          // QoS
    true,                       // retained
)
```

**Use case**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤.

---

### Retained Messages

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ** —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–æ–ø–∏–∫–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ broker. –ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞—é—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.

```go
client.Publish(
    "home/kitchen/temp",
    1,                  // QoS
    true,               // RETAINED
    []byte("22.5¬∞C"),
)
```

**Use case**: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —Å—Ç–∞—Ç—É—Å).

---

### Clean Session

```go
opts.SetCleanSession(false) // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
```

- **true**: –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è
- **false**: –ü–æ–¥–ø–∏—Å–∫–∏ –∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (QoS > 0) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | AMQP (RabbitMQ) | MQTT |
| :--- | :--- | :--- |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è (–º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—Ö–µ–º) | –ù–∏–∑–∫–∞—è (–ø—Ä–æ—Å—Ç–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ) |
| **–†–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è** | –î–æ 128 MB | –û–±—ã—á–Ω–æ < 256 MB |
| **–ì–∞—Ä–∞–Ω—Ç–∏–∏** | –û—á–µ–Ω—å –Ω–∞–¥–µ–∂–Ω–æ (Ack, Transactions) | –ì–∏–±–∫–æ (QoS 0, 1, 2) |
| **–†–µ—Å—É—Ä—Å—ã** | –¢—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏ | –û—á–µ–Ω—å –ª–µ–≥–∫–∏–π (2 KB overhead) |
| **Ordering** | –í —Ä–∞–º–∫–∞—Ö –æ—á–µ—Ä–µ–¥–∏ | –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è |
| **Persistence** | Durable queues | Retained messages + QoS |
| **–°—Ü–µ–Ω–∞—Ä–∏–π** | –ë—ç–∫–µ–Ω–¥, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã | –£–º–Ω—ã–π –¥–æ–º, —Å–µ–Ω—Å–æ—Ä—ã, –∞–≤—Ç–æ |
| **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** | 4 —Ç–∏–ø–∞ Exchange | Topic wildcards |
| **Security** | TLS, SASL, plugins | TLS, username/password |

---

## üíª –ü—Ä–∏–º–µ—Ä—ã –Ω–∞ Go

### RabbitMQ (AMQP)

**Publisher:**
```go
package main

import (
    "log"
    "github.com/streadway/amqp"
)

func main() {
    conn, _ := amqp.Dial("amqp://guest:guest@localhost:5672/")
    defer conn.Close()
    
    ch, _ := conn.Channel()
    defer ch.Close()
    
    // Declare exchange
    ch.ExchangeDeclare("logs", "fanout", true, false, false, false, nil)
    
    // Publish message
    err := ch.Publish(
        "logs", // exchange
        "",     // routing key (ignored for fanout)
        false,  // mandatory
        false,  // immediate
        amqp.Publishing{
            ContentType: "text/plain",
            Body:        []byte("Hello RabbitMQ!"),
        },
    )
    
    if err != nil {
        log.Fatal(err)
    }
    
    log.Println("Message published")
}
```

**Consumer:**
```go
package main

import (
    "log"
    "github.com/streadway/amqp"
)

func main() {
    conn, _ := amqp.Dial("amqp://guest:guest@localhost:5672/")
    defer conn.Close()
    
    ch, _ := conn.Channel()
    defer ch.Close()
    
    // Declare exchange
    ch.ExchangeDeclare("logs", "fanout", true, false, false, false, nil)
    
    // Declare exclusive queue
    q, _ := ch.QueueDeclare("", false, false, true, false, nil)
    
    // Bind queue to exchange
    ch.QueueBind(q.Name, "", "logs", false, nil)
    
    // Consume messages
    msgs, _ := ch.Consume(
        q.Name, // queue
        "",     // consumer
        false,  // auto-ack (manual ack!)
        false,  // exclusive
        false,  // no-local
        false,  // no-wait
        nil,    // args
    )
    
    forever := make(chan bool)
    
    go func() {
        for msg := range msgs {
            log.Printf("Received: %s", msg.Body)
            
            // Process message
            // ...
            
            // Manual acknowledgment
            msg.Ack(false)
        }
    }()
    
    log.Println("Waiting for messages...")
    <-forever
}
```

---

### MQTT

```go
package main

import (
    "fmt"
    "time"
    
    mqtt "github.com/eclipse/paho.mqtt.golang"
)

func main() {
    // Create client options
    opts := mqtt.NewClientOptions()
    opts.AddBroker("tcp://localhost:1883")
    opts.SetClientID("go_mqtt_client")
    opts.SetUsername("user")
    opts.SetPassword("pass")
    
    // Last Will and Testament
    opts.SetWill("devices/sensor1/status", "offline", 1, true)
    
    // OnConnect callback
    opts.OnConnect = func(c mqtt.Client) {
        fmt.Println("Connected to MQTT broker")
        
        // Subscribe to topics
        token := c.Subscribe("home/+/temperature", 1, messageHandler)
        token.Wait()
        fmt.Println("Subscribed to home/+/temperature")
    }
    
    // Create and start client
    client := mqtt.NewClient(opts)
    token := client.Connect()
    token.Wait()
    
    if token.Error() != nil {
        panic(token.Error())
    }
    
    // Publish messages
    for i := 0; i < 10; i++ {
        temp := fmt.Sprintf("%.1f¬∞C", 20.0+float64(i)*0.5)
        
        token := client.Publish(
            "home/kitchen/temperature",
            1,    // QoS
            true, // retained
            temp,
        )
        token.Wait()
        
        fmt.Printf("Published: %s\n", temp)
        time.Sleep(2 * time.Second)
    }
    
    // Keep connection alive
    time.Sleep(60 * time.Second)
    
    client.Disconnect(250)
}

// Message handler
func messageHandler(client mqtt.Client, msg mqtt.Message) {
    fmt.Printf("Received message on topic: %s\n", msg.Topic())
    fmt.Printf("Message: %s\n", msg.Payload())
}
```

---

> [!TIP]
> **–ß—Ç–æ –≤—ã–±—Ä–∞—Ç—å?**
> - –ï—Å–ª–∏ –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ —Å–ª–æ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∑–∞–∫–∞–∑–æ–≤ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–µ, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É ‚Üí –±–µ—Ä–∏—Ç–µ **AMQP/RabbitMQ**.
> - –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (topic, headers) ‚Üí **AMQP**.
> - –ï—Å–ª–∏ –≤—ã –¥–µ–ª–∞–µ—Ç–µ –æ—à–µ–π–Ω–∏–∫ –¥–ª—è —Å–æ–±–∞–∫–∏ —Å GPS, –¥–∞—Ç—á–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏, —É–º–Ω—ã–π –¥–æ–º ‚Üí –±–µ—Ä–∏—Ç–µ **MQTT**. üêæüí°
> - –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–∞ –Ω–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π overhead ‚Üí **MQTT**.
> - –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ offline –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Üí –æ–±–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –ø–æ–¥—Ö–æ–¥—è—Ç (clean session –≤ MQTT, durable queues –≤ AMQP).

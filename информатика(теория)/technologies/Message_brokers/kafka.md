# üêò Apache Kafka

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ß—Ç–æ —ç—Ç–æ? (–õ–æ–≥, –∞ –Ω–µ –æ—á–µ—Ä–µ–¥—å)](#1-—á—Ç–æ-—ç—Ç–æ-–ª–æ–≥-–∞-–Ω–µ-–æ—á–µ—Ä–µ–¥—å)
2. [–ë–∞–∑–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã](#2-–±–∞–∑–æ–≤—ã–µ-—Ç–µ—Ä–º–∏–Ω—ã)
3. [–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç? (Partitioning)](#3-–∫–∞–∫-—ç—Ç–æ-—Ä–∞–±–æ—Ç–∞–µ—Ç-partitioning)
4. [Consumer Groups](#4-consumer-groups)
5. [–ì–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (Delivery Semantics)](#5-–≥–∞—Ä–∞–Ω—Ç–∏–∏-–¥–æ—Å—Ç–∞–≤–∫–∏-delivery-semantics)
6. [–ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (Reliability)](#6-–ø–∞—Ç—Ç–µ—Ä–Ω—ã-–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏-reliability)
7. [Transactional Outbox](#7-transactional-outbox)

---

## 1. ü§î –ß—Ç–æ —ç—Ç–æ? (–õ–æ–≥, –∞ –Ω–µ –æ—á–µ—Ä–µ–¥—å)

–ú–Ω–æ–≥–∏–µ –¥—É–º–∞—é—Ç, —á—Ç–æ Kafka ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–∞–∫ RabbitMQ). –ù–æ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ –¥—É–º–∞—Ç—å –æ –Ω–µ–π –∫–∞–∫ –æ **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –ñ—É—Ä–Ω–∞–ª–µ –°–æ–±—ã—Ç–∏–π (Commit Log)**.

### üìú –ê–Ω–∞–ª–æ–≥–∏—è —Å –ñ—É—Ä–Ω–∞–ª–æ–º
*   **–û—á–µ—Ä–µ–¥—å (RabbitMQ)**: –í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø–∏—Å—å–º–æ, –¥—Ä—É–≥ –ø—Ä–æ—á–∏—Ç–∞–ª ‚Äî –ø–∏—Å—å–º–æ –∏—Å—á–µ–∑–ª–æ (—Å–≥–æ—Ä–µ–ª–æ).
*   **–ñ—É—Ä–Ω–∞–ª (Kafka)**: –í—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –∑–∞–ø–∏—Å—å –≤ —Ç–µ—Ç—Ä–∞–¥—å. –î—Ä—É–≥ –ø—Ä–æ—á–∏—Ç–∞–ª. –ó–∞–ø–∏—Å—å **–æ—Å—Ç–∞–ª–∞—Å—å**. –î—Ä—É–≥–æ–π –¥—Ä—É–≥ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –µ—ë –ø—Ä–æ—á–∏—Ç–∞—Ç—å.

> [!NOTE]
> **Kafka —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤–µ—á–Ω–æ** (–Ω—É –∏–ª–∏ —Å–∫–æ–ª—å–∫–æ –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç–µ: 3 –¥–Ω—è, –Ω–µ–¥–µ–ª—é, –≥–æ–¥). –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è!

---

## 2. üß± –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã

*   **Topic**: –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–∞–ø–∫–∞).
*   **Producer**: –ü–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ.
*   **Consumer**: –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (Pull model).
*   **Log**: –£–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π.

---

## 3. ‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç? (Partitioning)

–û–¥–∏–Ω —Ç–æ–ø–∏–∫ –ø–∏–ª—è—Ç –Ω–∞ –∫—É—Å–æ—á–∫–∏ ‚Äî **–ü–∞—Ä—Ç–∏—Ü–∏–∏**.
–≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞**. –û–¥–Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏—è ‚Äî –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ —á—Ç–µ–Ω–∏—è.

```mermaid
graph TB
    subgraph Topic ["–¢–æ–ø–∏–∫: Order-Events"]
        P0[Partition 0]
        P1[Partition 1]
    end
    
    Prod[Producer] -->|Key: User1| P0
    Prod -->|Key: User2| P1
```

> [!IMPORTANT]
> **–ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞**: –¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ **–æ–¥–Ω–æ–π** –ø–∞—Ä—Ç–∏—Ü–∏–∏.
> A –∏ B –≤ –æ–¥–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø—Ä–∏–¥—É—Ç –∫–∞–∫ A -> B.
> A –∏ B –≤ —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏—è—Ö –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ –∫–∞–∫ B -> A.

---

## 4. üë• Consumer Groups

–ì—Ä—É–ø–ø–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å —Ç–æ–ø–∏–∫ –±—ã—Å—Ç—Ä–µ–µ.
–ö–∞–∂–¥–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è –¥–æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ **–æ–¥–Ω–æ–º—É** –∫–æ–Ω—Å—å—é–º–µ—Ä—É –≤ –≥—Ä—É–ø–ø–µ.

---

## 5. ü§ù –ì–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (Delivery Semantics)

–ö–∞–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è?

### üì® Acknowledgement (acks)
–ö–æ–≥–¥–∞ –ü—Ä–æ–¥—é—Å–µ—Ä –ø–∏—à–µ—Ç –≤ –ö–∞—Ñ–∫—É, –æ–Ω –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä–∞–∑–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
*   `acks=0`: "–í—ã—Å—Ç—Ä–µ–ª–∏–ª –∏ –∑–∞–±—ã–ª". –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ.
*   `acks=1`: –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ—Ç –õ–∏–¥–µ—Ä–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏.
*   `acks=all`: –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –õ–∏–¥–µ—Ä–∞ –∏ **–≤—Å–µ—Ö** –∂–∏–≤—ã—Ö —Ä–µ–ø–ª–∏–∫ (ISR). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å.

### –£—Ä–æ–≤–Ω–∏ –≥–∞—Ä–∞–Ω—Ç–∏–π
1.  **At-most-once (–ù–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞)**
    *   –°–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–æ–¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è.
    *   *–ö–∞–∫*: `acks=0`, –∏–ª–∏ –∫–æ–Ω—Å—å—é–º–µ—Ä –∫–æ–º–º–∏—Ç–∏—Ç –æ—Ñ—Å–µ—Ç **–¥–æ** –æ–±—Ä–∞–±–æ—Ç–∫–∏.
2.  **At-least-once (–•–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑)** ‚Äî *–°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–µ-—Ñ–∞–∫—Ç–æ*.
    *   –°–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ—á–Ω–æ –¥–æ–π–¥–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –¥–≤–∞–∂–¥—ã (–¥—É–±–ª—å).
    *   *–ö–∞–∫*: `acks=all`, –∫–æ–Ω—Å—å—é–º–µ—Ä –∫–æ–º–º–∏—Ç–∏—Ç –æ—Ñ—Å–µ—Ç **–ø–æ—Å–ª–µ** —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
    *   *–ü—Ä–æ–±–ª–µ–º–∞*: –ï—Å–ª–∏ –∫–æ–Ω—Å—å—é–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–ª, –Ω–æ —É–ø–∞–ª –¥–æ –∫–æ–º–º–∏—Ç–∞, –æ–Ω –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.
3.  **Exactly-once (–†–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑)**
    *   –°–≤—è—Ç–æ–π –ì—Ä–∞–∞–ª—å.
    *   *–í–Ω—É—Ç—Ä–∏ Kafka*: –ò—Å–ø–æ–ª—å–∑—É—è Idempotent Producer (`enable.idempotence=true`) –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
    *   *End-to-End*: –¢—Ä–µ–±—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ (–ë–î).

> [!IMPORTANT]
> **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Äî —Å–≤–æ–π—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–∞–≤–∞—Ç—å —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—ã–∑–æ–≤–µ.
> –ü—Ä–∏–º–µ—Ä: `Update User Set Status = Active` (–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ). `User.Balance += 100` (–ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ, –ø—Ä–∏–¥–µ—Ç 2 —Ä–∞–∑–∞ ‚Äî –Ω–∞—á–∏—Å–ª–∏–º 200).
> –õ—É—á—à–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –≤ –ë–î.

---

## 6. üõ°Ô∏è –ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (Reliability)

### üíÄ Dead Letter Queue (DLQ)
–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ "–±–∏—Ç–æ–µ" –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –≤ –∫–æ–¥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON)?
–ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫—É, –∫–æ–Ω—Å—å—é–º–µ—Ä –±—É–¥–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –µ–≥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ (**Infinite Loop**).

**–†–µ—à–µ–Ω–∏–µ**:
1.  –ü—ã—Ç–∞–µ–º—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å N —Ä–∞–∑ (Retry).
2.  –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—à–∏–±–∫–∞ ‚Äî –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ **DLQ** (–∫–ª–∞–¥–±–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π).
3.  –ö–æ–º–º–∏—Ç–∏–º –æ—Ñ—Å–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ç–æ–ø–∏–∫–µ –∏ –∏–¥–µ–º –¥–∞–ª—å—à–µ.
4.  –ê–¥–º–∏–Ω —Å–º–æ—Ç—Ä–∏—Ç DLQ, —á–∏–Ω–∏—Ç –±–∞–≥ –∏ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è ("Replay").

---

## 7. üì¶ Transactional Outbox

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤: **Dual Write**.
–í–∞–º –Ω—É–∂–Ω–æ:
1.  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç—å `User` –≤ Postgres.
2.  –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ `UserCreated` –≤ Kafka.

–ï—Å–ª–∏ 1 —É–ø–∞–¥–µ—Ç ‚Äî –≤—Å—ë –æ–∫. –ï—Å–ª–∏ 1 –æ–∫, –∞ 2 —É–ø–∞–¥–µ—Ç (—Å–µ—Ç—å –º–æ—Ä–≥–Ω—É–ª–∞) ‚Äî —É –≤–∞—Å **–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω**. –Æ–∑–µ—Ä —Å–æ–∑–¥–∞–Ω, –∞ –ø–∏—Å—å–º–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ (Outbox Pattern)**:
–í –æ–¥–Ω–æ–π –ë–î —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ `User`, –∏ `Event` (–≤ —Ç–∞–±–ª–∏—á–∫—É `outbox`).
`User` –∏ `Event` –∫–æ–º–º–∏—Ç—è—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ (–∏–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–±–∞, –∏–ª–∏ –Ω–∏–∫—Ç–æ).

```mermaid
graph LR
    App[Service] -->|Transaction| DB[(Postgres)]
    DB --> Tab1[Table: Users]
    DB --> Tab2[Table: Outbox]
    
    Relay[CDC / Poller] -->|Reads| Tab2
    Relay -->|Publishes| Kafka{Kafka}
```

*   **CDC (Change Data Capture)**: –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ç—É–ª–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, **Debezium**) —á–∏—Ç–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω—ã–µ –ª–æ–≥–∏ (WAL) –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Å–∞–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –ö–∞—Ñ–∫—É. –≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.
# üèÉ Escape Analysis –≤ Go

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ß—Ç–æ —Ç–∞–∫–æ–µ Escape Analysis](#—á—Ç–æ-—Ç–∞–∫–æ–µ-escape-analysis)
2. [Stack vs Heap: –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è](#stack-vs-heap-—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ-–ø–æ–Ω—è—Ç–∏—è)
3. [–ó–∞—á–µ–º –Ω—É–∂–µ–Ω Escape Analysis](#–∑–∞—á–µ–º-–Ω—É–∂–µ–Ω-escape-analysis)
4. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Escape Analysis](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-escape-analysis)
5. [–ö–æ–≥–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è "—É–±–µ–≥–∞–µ—Ç" –Ω–∞ heap](#–∫–æ–≥–¥–∞-–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è-—É–±–µ–≥–∞–µ—Ç-–Ω–∞-heap)
6. [–ö–æ–≥–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ stack](#–∫–æ–≥–¥–∞-–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è-–æ—Å—Ç–∞–µ—Ç—Å—è-–Ω–∞-stack)
7. [–ú–∞—Å—Å–∏–≤—ã –∏ —Å–ª–∞–π—Å—ã: –†–æ–ª—å —Ä–∞–∑–º–µ—Ä–∞](#–º–∞—Å—Å–∏–≤—ã-–∏-—Å–ª–∞–π—Å—ã-—Ä–æ–ª—å-—Ä–∞–∑–º–µ—Ä–∞)
8. [–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏](#–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
9. [–ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏](#–ø–æ–¥–≤–æ–¥–Ω—ã–µ-–∫–∞–º–Ω–∏)
10. [Best Practices](#best-practices)

---

## ‚ùì –ß—Ç–æ —Ç–∞–∫–æ–µ Escape Analysis

**Escape Analysis** ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä Go –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏. –ï–≥–æ –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –≥–¥–µ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –≤—ã–¥–µ–ª–∏—Ç—å –ø–∞–º—è—Ç—å –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: –Ω–∞ **—Å—Ç–µ–∫–µ** (stack) –∏–ª–∏ –≤ **–∫—É—á–µ** (heap).

> [!NOTE]
> **Escape Analysis** ‚Äî —ç—Ç–æ –Ω–µ runtime-–º–µ—Ö–∞–Ω–∏–∑–º. –†–µ—à–µ–Ω–∏–µ –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è **–¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã**, –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏.

> [!WARNING]
> **–í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å**: Escape Analysis ‚Äî —ç—Ç–æ –Ω–∞–±–æ—Ä —ç–≤—Ä–∏—Å—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è—é—Ç—Å—è –æ—Ç –≤–µ—Ä—Å–∏–∏ –∫ –≤–µ—Ä—Å–∏–∏ Go. –¢–æ, —á—Ç–æ "—É–ª–µ—Ç–∞–ª–æ" –≤ –∫—É—á—É –≤ Go 1.10, –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Å—Ç–µ–∫–µ –≤ Go 1.24. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ 100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–ª–∞–≥–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (`-gcflags="-m"`). –î–∞–∂–µ –µ—Å–ª–∏ –∫–æ–¥ –∫–∞–∂–µ—Ç—Å—è –æ—á–µ–≤–∏–¥–Ω—ã–º, —Å–ª–æ–∂–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, inlining) –º–æ–≥—É—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:**
```mermaid
graph TD
    A[–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ Go] --> B[–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: Escape Analysis]
    B --> C{–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∂–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é?}
    C -->|–ù–µ—Ç: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ| D[Stack Allocation]
    C -->|–î–∞: –í—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã| E[Heap Allocation]
    D --> F[–ë—ã—Å—Ç—Ä–æ, –±–µ–∑ GC]
    E --> G[–ú–µ–¥–ª–µ–Ω–Ω–µ–µ, —Ç—Ä–µ–±—É–µ—Ç GC]
```

---

## ü•û Stack vs Heap: –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è

### Stack (–°—Ç–µ–∫)

**Stack** ‚Äî —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É LIFO (Last In, First Out). –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π **stack frame** (–∫–∞–¥—Ä —Å—Ç–µ–∫–∞), –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è:
- –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏
- –ê–¥—Ä–µ—Å –≤–æ–∑–≤—Ä–∞—Ç–∞

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ **–û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–µ** –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ (–ø—Ä–æ—Å—Ç–æ —Å–¥–≤–∏–≥ —É–∫–∞–∑–∞—Ç–µ–ª—è)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ** —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é (–≤—ã—Ö–æ–¥ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ = –æ—á–∏—Å—Ç–∫–∞)
- ‚úÖ **–ù–µ —Ç—Ä–µ–±—É–µ—Ç GC** (Garbage Collector)
- ‚ùå **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä** (–æ–±—ã—á–Ω–æ 1-8 MB –Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω—É)
- ‚ùå **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏** –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏

### Heap (–ö—É—á–∞)

**Heap** ‚Äî —ç—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏, —Å–æ–≤–º–µ—Å—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –≤—Å–µ–º–∏ –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏.

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ **–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä** (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–æ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –ø–∞–º—è—Ç–∏)
- ‚úÖ **–î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–µ** –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
- ‚ùå **–ú–µ–¥–ª–µ–Ω–Ω–µ–µ** –≤—ã–¥–µ–ª–µ–Ω–∏–µ (allocator –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—ã–π –±–ª–æ–∫)
- ‚ùå **–¢—Ä–µ–±—É–µ—Ç GC** –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
- ‚ùå **–§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è** –ø–∞–º—è—Ç–∏

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
```mermaid
graph TB
    subgraph Stack ["Stack (–ë—ã—Å—Ç—Ä–æ, LIFO)"]
        SF1[Stack Frame: main]
        SF2[Stack Frame: foo]
        SF3[Stack Frame: bar]
    end
    subgraph Heap ["Heap (–ú–µ–¥–ª–µ–Ω–Ω–æ, GC)"]
        H1[Object 1]
        H2[Object 2]
        H3[Object 3]
    end
    SF3 -.->|–£–∫–∞–∑–∞—Ç–µ–ª—å| H2
    SF1 -.->|–£–∫–∞–∑–∞—Ç–µ–ª—å| H1
```

> [!IMPORTANT]
> **–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ**: Stack ‚Äî –¥–ª—è –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. Heap ‚Äî –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–∂–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é.

---

## üéØ –ó–∞—á–µ–º –Ω—É–∂–µ–Ω Escape Analysis

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **Stack allocation** –≤ **100-1000 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**, —á–µ–º heap allocation
- –ù–µ—Ç overhead –æ—Ç —Ä–∞–±–æ—Ç—ã GC (–∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å" –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ STW –ø–∞—É–∑—ã)

### 2. –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GC

- –ß–µ–º –º–µ–Ω—å—à–µ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ heap, —Ç–µ–º –º–µ–Ω—å—à–µ —Ä–∞–±–æ—Ç—ã —É Garbage Collector
- GC "–≤–∏–¥–∏—Ç" —Ç–æ–ª—å–∫–æ heap. Stack –æ—á–∏—â–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏

### 3. –£–ª—É—á—à–µ–Ω–∏–µ cache locality

- –î–∞–Ω–Ω—ã–µ –Ω–∞ stack —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- CPU cache —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
```go
// Stack allocation (–±—ã—Å—Ç—Ä–æ)
func sumStack() int {
    x := 42  // x –Ω–∞ stack
    y := 58  // y –Ω–∞ stack
    return x + y
}

// Heap allocation (–º–µ–¥–ª–µ–Ω–Ω–æ)
func sumHeap() *int {
    x := 42
    result := x + 58
    return &result  // result "—É–±–µ–≥–∞–µ—Ç" –Ω–∞ heap!
}
```

```
Benchmark_StackAlloc-8    1000000000    0.25 ns/op    0 B/op    0 allocs/op
Benchmark_HeapAlloc-8      50000000    35.2 ns/op    8 B/op    1 allocs/op
```

> [!TIP]
> –†–∞–∑–Ω–∏—Ü–∞ –≤ **140 —Ä–∞–∑**! –í–æ—Ç –ø–æ—á–µ–º—É Escape Analysis —Ç–∞–∫ –≤–∞–∂–µ–Ω.

---

## ‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Escape Analysis

–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä Go –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ AST (–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ) –≤–∞—à–µ–≥–æ –∫–æ–¥–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç **–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏** –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.

### –ê–ª–≥–æ—Ä–∏—Ç–º (—É–ø—Ä–æ—â–µ–Ω–Ω–æ):

1. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä —Å–º–æ—Ç—Ä–∏—Ç, –∫—É–¥–∞ "—Ç–µ—á–µ—Ç" –∫–∞–∂–¥–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
2. **–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏**: –ú–æ–∂–µ—Ç –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–∂–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é?
3. **–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è**:
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ñ—É–Ω–∫—Ü–∏–∏ ‚Üí **Stack**
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∑–∞–º—ã–∫–∞–Ω–∏–∏, –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Üí **Heap**

**–°—Ö–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞:**
```mermaid
sequenceDiagram
    participant C as –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä
    participant V as –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è x
    participant F as –§—É–Ω–∫—Ü–∏—è foo
    
    C->>V: –°–æ–∑–¥–∞–Ω–∞ –≤ foo()
    C->>V: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–¥–µ?
    alt –¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ foo()
        V-->>C: –õ–æ–∫–∞–ª—å–Ω–∞—è
        C->>F: Stack allocation
    else –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è / –≤ –∑–∞–º—ã–∫–∞–Ω–∏–∏ / –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        V-->>C: Escape!
        C->>F: Heap allocation
    end
```

---

## üöÄ –ö–æ–≥–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è "—É–±–µ–≥–∞–µ—Ç" –Ω–∞ heap

### 1. –í–æ–∑–≤—Ä–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è

```go
func createUser() *User {
    u := User{Name: "Alice"}  // u escapes to heap
    return &u
}
```

**–ü–æ—á–µ–º—É?** –í—ã–∑—ã–≤–∞—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `u` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è `createUser()`.

---

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

```go
var globalUsers []*User

func addUser() {
    u := User{Name: "Bob"}  // u escapes to heap
    globalUsers = append(globalUsers, &u)
}
```

**–ü–æ—á–µ–º—É?** `u` –¥–æ–ª–∂–Ω–∞ –∂–∏—Ç—å –¥–æ–ª—å—à–µ, —á–µ–º —Ñ—É–Ω–∫—Ü–∏—è `addUser()`.

---

### 3. –ó–∞–º—ã–∫–∞–Ω–∏—è (Closures)

```go
func counter() func() int {
    count := 0  // count escapes to heap!
    return func() int {
        count++
        return count
    }
}
```

**–ü–æ—á–µ–º—É?** –í–æ–∑–≤—Ä–∞—â–∞–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏—è "–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç" `count`, –∏ –æ–Ω –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏.

**–°—Ö–µ–º–∞:**
```mermaid
graph TD
    A[counter –≤—ã–∑–≤–∞–Ω–∞] --> B[count —Å–æ–∑–¥–∞–Ω–∞]
    B --> C[–ê–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç count]
    C --> D[counter –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è]
    D --> E[count –¥–æ–ª–∂–Ω–∞ –∂–∏—Ç—å –¥–∞–ª—å—à–µ!]
    E --> F[Heap allocation]
```

---

### 4. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

```go
func printValue() {
    x := 42  // x escapes to heap!
    var i interface{} = x
    fmt.Println(i)
}
```

**–ü–æ—á–µ–º—É?** –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤ Go —Ö—Ä–∞–Ω—è—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ. –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ `x` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–¥–µ-—Ç–æ –µ—â–µ.

---

### 5. –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```go
func createLargeArray() {
    arr := [100000]int{}  // –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è stack!
    // arr escapes to heap
    process(arr)
}
```

**–ü–æ—á–µ–º—É?** Stack –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (–æ–±—ã—á–Ω–æ 1-8 MB –Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω—É). –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–∫—Ç—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –Ω–∞ heap.

---

### 6. –ü–µ—Ä–µ–¥–∞—á–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª

```go
func sendData(ch chan *Data) {
    d := Data{Value: 10}  // d escapes to heap
    ch <- &d
}
```

**–ü–æ—á–µ–º—É?** –ü–æ–ª—É—á–∞—Ç–µ–ª—å –∏–∑ –¥—Ä—É–≥–æ–π –≥–æ—Ä—É—Ç–∏–Ω—ã –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `d` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏.

---

### 7. –°–ª–∞–π—Å—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º —Ä–∞–∑–º–µ—Ä–æ–º

```go
func makeSlice(n int) []int {
    s := make([]int, n)  // s escapes to heap
    return s
}
```

**–ü–æ—á–µ–º—É?** –†–∞–∑–º–µ—Ä `n` –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏, –ø–æ—ç—Ç–æ–º—É –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –≤—ã–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ stack.

---

### 8. –ú–µ—Ç–æ–¥—ã –Ω–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è—Ö

```go
type Counter struct {
    value int
}

func (c *Counter) Increment() {
    c.value++
}

func newCounter() *Counter {
    c := Counter{}  // c escapes to heap
    return &c
}
```

---

### 9. Defer —Å –∑–∞—Ö–≤–∞—Ç–æ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

```go
func processFile() error {
    f, _ := os.Open("file.txt")
    defer f.Close()  // f –º–æ–∂–µ—Ç escape, –µ—Å–ª–∏ Close() —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Å—Å—ã–ª–∫—É
    // ...
}
```

---

### 10. –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞ —Å—Ä–µ–∑–∞/—Å—Ç—Ä–æ–∫–∏

```go
func concat(a, b string) string {
    return a + b  // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç escape, –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
}
```

---

## üè† –ö–æ–≥–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ stack

### 1. –ü—Ä–æ—Å—Ç—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```go
func calculate() int {
    x := 10  // Stack
    y := 20  // Stack
    return x + y
}
```

---

### 2. –ú–∞—Å—Å–∏–≤—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–Ω–µ–±–æ–ª—å—à–∏–µ)

```go
func sumArray() int {
    arr := [10]int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10}  // Stack
    sum := 0
    for _, v := range arr {
        sum += v
    }
    return sum
}
```

---

### 3. –°—Ç—Ä—É–∫—Ç—É—Ä—ã, –Ω–µ –ø–æ–∫–∏–¥–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏—é

```go
func processLocal() {
    u := User{Name: "Charlie"}  // Stack
    fmt.Println(u.Name)  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
}
```

---

### 4. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏ (value types)

```go
func add(a, b int) int {  // a, b –Ω–∞ Stack
    return a + b
}
```

---

### 5. –°–ª–∞–π—Å—ã —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º (inlined)

```go
func smallSlice() {
    s := make([]int, 3)  // –ú–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ stack (–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä —É–º–Ω—ã–π!)
    s[0] = 1
    s[1] = 2
    s[2] = 3
    fmt.Println(s)
}
```

> [!NOTE]
> –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ Go (1.17+) —É–ª—É—á—à–∏–ª–∏ Escape Analysis, –∏ –Ω–µ–±–æ–ª—å—à–∏–µ —Å–ª–∞–π—Å—ã —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –º–æ–≥—É—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ stack.

---

## üìä –ú–∞—Å—Å–∏–≤—ã –∏ —Å–ª–∞–π—Å—ã: –†–æ–ª—å —Ä–∞–∑–º–µ—Ä–∞

–≠—Ç–æ –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∏ —Ç–æ–Ω–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤ Escape Analysis.

### –ú–∞—Å—Å–∏–≤—ã: `[N]T`

–ú–∞—Å—Å–∏–≤—ã ‚Äî —ç—Ç–æ **value type** (—Ç–∏–ø-–∑–Ω–∞—á–µ–Ω–∏–µ). –ò—Ö —Ä–∞–∑–º–µ—Ä –∏–∑–≤–µ—Å—Ç–µ–Ω –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏.

#### –°–ª—É—á–∞–π 1: –ú–∞–ª–µ–Ω—å–∫–∏–π –º–∞—Å—Å–∏–≤

```go
func smallArray() {
    arr := [10]int{}  // Stack (40 –±–∞–π—Ç –¥–ª—è int32 –∏–ª–∏ 80 –¥–ª—è int64)
    arr[0] = 42
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Stack allocation ‚úÖ

---

#### –°–ª—É—á–∞–π 2: –ë–æ–ª—å—à–æ–π –º–∞—Å—Å–∏–≤

```go
func largeArray() {
    arr := [1000000]int{}  // Heap! (4-8 MB)
    arr[0] = 42
}

// go build -gcflags='-m' main.go
// ./main.go: arr escapes to heap
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Heap allocation ‚ö†Ô∏è

**–ü–æ—á–µ–º—É?** Stack –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –±–æ–ª—å—à–µ, —á–µ–º **~64KB**, –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–≥–æ –Ω–∞ heap.

---

#### –°–ª—É—á–∞–π 3: –í–æ–∑–≤—Ä–∞—Ç –º–∞—Å—Å–∏–≤–∞

```go
func returnArray() [10]int {
    arr := [10]int{1, 2, 3}
    return arr  // –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è! Stack
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Stack allocation (–º–∞—Å—Å–∏–≤ **–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è** –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ)

---

#### –°–ª—É—á–∞–π 4: –í–æ–∑–≤—Ä–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ –º–∞—Å—Å–∏–≤

```go
func returnArrayPtr() *[10]int {
    arr := [10]int{1, 2, 3}
    return &arr  // arr escapes to heap!
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Heap allocation

---

### –°–ª–∞–π—Å—ã: `[]T`

–°–ª–∞–π—Å ‚Äî —ç—Ç–æ **—Å—Å—ã–ª–æ—á–Ω—ã–π —Ç–∏–ø**. –í–Ω—É—Ç—Ä–∏ –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö
- –î–ª–∏–Ω—É (`len`)
- –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (`cap`)

#### –°–ª—É—á–∞–π 1: –ö–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

```go
func fixedSlice() {
    s := make([]int, 10)  // Stack (–µ—Å–ª–∏ –Ω–µ escape)
    s[0] = 42
    fmt.Println(s)
}

// –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –≤–∏–¥–∏—Ç: —Ä–∞–∑–º–µ—Ä = 10 (const), –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
// –†–µ–∑—É–ª—å—Ç–∞—Ç: Stack (–≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Go)
```

---

#### –°–ª—É—á–∞–π 2: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä

```go
func dynamicSlice(n int) {
    s := make([]int, n)  // Heap! (n –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –Ω–∞ compile-time)
    s[0] = 42
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Heap allocation

**–ü–æ—á–µ–º—É?** –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –Ω–µ –∑–Ω–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –ø–∞–º—è—Ç–∏ –Ω—É–∂–Ω–æ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã.

---

#### –°–ª—É—á–∞–π 3: –í–æ–∑–≤—Ä–∞—Ç —Å–ª–∞–π—Å–∞

```go
func returnSlice() []int {
    s := make([]int, 10)
    return s  // s escapes to heap!
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Heap allocation

**–ü–æ—á–µ–º—É?** –í—ã–∑—ã–≤–∞—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –∂–∏—Ç—å –¥–æ–ª—å—à–µ.

---

#### –°–ª—É—á–∞–π 4: Append —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ä–æ—Å—Ç–æ–º

```go
func appendData() {
    s := []int{1, 2, 3}  // Stack (–ø–æ–∫–∞)
    s = append(s, 4)     // –ú–æ–∂–µ—Ç escape, –µ—Å–ª–∏ —Ä–æ—Å—Ç —Ç—Ä–µ–±—É–µ—Ç realloc
}
```

---

### –°—Ö–µ–º–∞: –ú–∞—Å—Å–∏–≤—ã vs –°–ª–∞–π—Å—ã

```mermaid
graph TD
    A["–ú–∞—Å—Å–∏–≤ vs –°–ª–∞–π—Å"] --> B{"–ú–∞—Å—Å–∏–≤ [N]T"}
    A --> C{"–°–ª–∞–π—Å []T"}
    
    B --> B1{–†–∞–∑–º–µ—Ä N?}
    B1 -->|–ú–∞–ª–µ–Ω—å–∫–∏–π < 64KB| B2[Stack]
    B1 -->|–ë–æ–ª—å—à–æ–π > 64KB| B3[Heap]
    
    C --> C1{–†–∞–∑–º–µ—Ä –∏–∑–≤–µ—Å—Ç–µ–Ω?}
    C1 -->|Const: make n, 10| C2{Escapes?}
    C1 -->|Dynamic: make n, n| C3[Heap]
    
    C2 -->|–ù–µ—Ç| C4[Stack –≤–æ–∑–º–æ–∂–µ–Ω]
    C2 -->|–î–∞: return/closure| C5[Heap]
```

---

### –¢–∞–±–ª–∏—Ü–∞: –ú–∞—Å—Å–∏–≤—ã vs –°–ª–∞–π—Å—ã

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ú–∞—Å—Å–∏–≤ `[N]T` | –°–ª–∞–π—Å `[]T` |
|:---|:---:|:---:|
| –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä | Stack ‚úÖ | Stack* ‚úÖ |
| –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä (>64KB) | Heap ‚ö†Ô∏è | Heap ‚ö†Ô∏è |
| –í–æ–∑–≤—Ä–∞—Ç –∑–Ω–∞—á–µ–Ω–∏—è | Stack (–∫–æ–ø–∏—è) | Heap ‚ö†Ô∏è |
| –í–æ–∑–≤—Ä–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è `&arr` | Heap ‚ö†Ô∏è | Heap ‚ö†Ô∏è |
| –†–∞–∑–º–µ—Ä –∏–∑–≤–µ—Å—Ç–µ–Ω –Ω–∞ compile-time | Stack ‚úÖ | Stack* ‚úÖ |
| –†–∞–∑–º–µ—Ä –∏–∑–≤–µ—Å—Ç–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ runtime | N/A | Heap ‚ö†Ô∏è |

*–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏ Go –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 1. –§–ª–∞–≥ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ `-m`

–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Escape Analysis:

```bash
go build -gcflags='-m' main.go
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
./main.go:5:2: moved to heap: x
./main.go:10:13: ... argument does not escape
./main.go:10:13: s escapes to heap
```

---

### 2. –£—Ä–æ–≤–Ω–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

```bash
# –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
go build -gcflags='-m'

# –ë–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π
go build -gcflags='-m -m'

# –ú–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
go build -gcflags='-m -m -m'
```

---

### 3. –ü—Ä–∏–º–µ—Ä –∞–Ω–∞–ª–∏–∑–∞

**–ö–æ–¥:**
```go
package main

import "fmt"

func createUser() *User {
    u := User{Name: "Alice"}
    return &u
}

type User struct {
    Name string
}

func main() {
    user := createUser()
    fmt.Println(user.Name)
}
```

**–ö–æ–º–∞–Ω–¥–∞:**
```bash
go build -gcflags='-m' main.go
```

**–í—ã–≤–æ–¥:**
```
./main.go:5:2: moved to heap: u
./main.go:6:9: &u escapes to heap
./main.go:15:13: ... argument does not escape
./main.go:15:25: user.Name escapes to heap
```

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:**
- `moved to heap: u` ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `u` —Ä–∞–∑–º–µ—â–µ–Ω–∞ –Ω–∞ heap
- `&u escapes to heap` ‚Äî –ø—Ä–∏—á–∏–Ω–∞: –≤–æ–∑–≤—Ä–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è
- `user.Name escapes to heap` ‚Äî `fmt.Println` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç interface{}, –≤—ã–∑—ã–≤–∞—è escape

---

### 4. Benchmarking

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è allocations:

```go
func BenchmarkStackAlloc(b *testing.B) {
    for i := 0; i < b.N; i++ {
        sumStack()
    }
}

func BenchmarkHeapAlloc(b *testing.B) {
    for i := 0; i < b.N; i++ {
        sumHeap()
    }
}
```

**–ó–∞–ø—É—Å–∫:**
```bash
go test -bench=. -benchmem
```

**–í–∞–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- `allocs/op` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ heap allocations –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
- `B/op` ‚Äî –±–∞–π—Ç –≤—ã–¥–µ–ª–µ–Ω–æ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é

---

## üï≥Ô∏è –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

### 1. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—é—Ç escape

```go
func printInt(x int) {
    fmt.Println(x)  // x escapes! (fmt.Println –ø—Ä–∏–Ω–∏–º–∞–µ—Ç interface{})
}
```

**–†–µ—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∏–∑–±–µ–≥–∞–π—Ç–µ `fmt.Println` –≤ hot path.

---

### 2. Defer –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å escape

```go
func process() {
    x := 42
    defer fmt.Println(x)  // x –º–æ–∂–µ—Ç escape
}
```

**–ü–æ—á–µ–º—É?** `defer` –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–æ–¥–ª–µ–≤–∞—è –∏—Ö –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏.

---

### 3. –ù–µ–±–æ–ª—å—à–∏–µ —Å–ª–∞–π—Å—ã –º–æ–≥—É—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ stack

```go
func optimized() {
    s := make([]int, 3)  // Stack –≤ Go 1.17+
    s[0] = 1
    // –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
}
```

–ù–æ —ç—Ç–æ **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**! –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

---

### 4. Append –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π escape

```go
func grow() []int {
    s := []int{1, 2, 3}  // –ú–æ–∂–µ—Ç think: Stack
    s = append(s, 4, 5, 6, 7)  // Realloc ‚Üí Heap!
    return s
}
```

---

### 5. –¶–∏–∫–ª—ã –∏ escape analysis

```go
func loop() {
    for i := 0; i < 10; i++ {
        x := i  // x –Ω–∞ stack (–∫–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è - –Ω–æ–≤—ã–π —Ñ—Ä–µ–π–º)
        fmt.Println(&x)  // –ù–æ –∞–¥—Ä–µ—Å —Ä–∞–∑–Ω—ã–π –∫–∞–∂–¥—ã–π —Ä–∞–∑!
    }
}
```

---

### 6. Variadic —Ñ—É–Ω–∫—Ü–∏–∏ (...)

```go
func sum(nums ...int) {  // nums ‚Äî —ç—Ç–æ —Å–ª–∞–π—Å ‚Üí –º–æ–∂–µ—Ç escape
    // ...
}

sum(1, 2, 3)  // –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ª–∞–π—Å
```

---

## ‚úÖ Best Practices

### 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ value receivers, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

```go
// –ü–ª–æ—Ö–æ (escape)
func (u *User) GetName() string {
    return u.Name
}

// –•–æ—Ä–æ—à–æ (stack)
func (u User) GetName() string {
    return u.Name
}
```

---

### 2. –ò–∑–±–µ–≥–∞–π—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

```go
// –ü–ª–æ—Ö–æ
func createConfig() *Config {
    return &Config{Timeout: 30}
}

// –•–æ—Ä–æ—à–æ
func createConfig() Config {
    return Config{Timeout: 30}
}
```

---

### 3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É–ª—ã –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (sync.Pool)

```go
var bufferPool = sync.Pool{
    New: func() interface{} {
        return new(bytes.Buffer)
    },
}

func process() {
    buf := bufferPool.Get().(*bytes.Buffer)
    defer bufferPool.Put(buf)
    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ buf
}
```

---

### 4. –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ –º–∞—Å—Å–∏–≤—ã —Å–ª–∞–π—Å–∞–º (–µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –∏–∑–≤–µ—Å—Ç–µ–Ω)

```go
// –•–æ—Ä–æ—à–æ (Stack)
func processFixed() {
    arr := [100]int{}
    // ...
}

// –ú–æ–∂–µ—Ç escape
func processDynamic() {
    s := make([]int, 100)
    // ...
}
```

---

### 5. –ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–¥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π

```bash
# CPU –ø—Ä–æ—Ñ–∏–ª—å
go test -cpuprofile=cpu.prof -bench=.

# Heap –ø—Ä–æ—Ñ–∏–ª—å
go test -memprofile=mem.prof -bench=.

# –ê–Ω–∞–ª–∏–∑
go tool pprof cpu.prof
```

---

### 6. –ù–µ –º–∏–∫—Ä–æ-–æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –±–µ–∑ –∏–∑–º–µ—Ä–µ–Ω–∏–π

> [!WARNING]
> "Premature optimization is the root of all evil" ‚Äî Donald Knuth

–°–Ω–∞—á–∞–ª–∞ –±–µ–Ω—á–º–∞—Ä–∫, –ø–æ—Ç–æ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è!

---

## –ò—Ç–æ–≥–∏

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

| –ö–æ–Ω—Ü–µ–ø—Ü–∏—è | –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ |
|:---|:---|
| **Escape Analysis** | –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä —Ä–µ—à–∞–µ—Ç: Stack –∏–ª–∏ Heap |
| **Stack** | –ë—ã—Å—Ç—Ä–æ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω |
| **Heap** | –ú–µ–¥–ª–µ–Ω–Ω–æ, GC, –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω |
| **Escape —Ç—Ä–∏–≥–≥–µ—Ä—ã** | –í–æ–∑–≤—Ä–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∑–∞–º—ã–∫–∞–Ω–∏—è, –∫–∞–Ω–∞–ª—ã |
| **–ú–∞—Å—Å–∏–≤—ã [N]T** | Stack (–µ—Å–ª–∏ <64KB), Heap (–µ—Å–ª–∏ >64KB –∏–ª–∏ &arr) |
| **–°–ª–∞–π—Å—ã []T** | Heap (–µ—Å–ª–∏ dynamic size –∏–ª–∏ escape) |
| **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** | `-gcflags='-m'`, benchmarks, pprof |

---

### –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

**–ü–∏—à–∏—Ç–µ —á–∏—Ç–∞–µ–º—ã–π –∫–æ–¥, –∑–∞—Ç–µ–º –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É–π—Ç–µ, –∑–∞—Ç–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ.**

Escape Analysis ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –Ω–æ –Ω–µ —Å—Ç–æ–∏—Ç –∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å —è—Å–Ω–æ—Å—Ç—å—é –∫–æ–¥–∞ —Ä–∞–¥–∏ –º–∏–∫—Ä–æ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–∞ Go —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–ª–∏—á–Ω–æ –±–µ–∑ —Ä—É—á–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ allocations.

---

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Go Official Blog: Escape Analysis](https://go.dev/blog/ismmkeynote)
- [Go Compiler Internals](https://github.com/golang/go/blob/master/src/cmd/compile/internal/gc/escape.go)
- [Effective Go](https://go.dev/doc/effective_go)

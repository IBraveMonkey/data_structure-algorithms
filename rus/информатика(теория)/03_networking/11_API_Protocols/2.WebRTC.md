# üìû WebRTC: –û–±—â–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ß—Ç–æ —Ç–∞–∫–æ–µ WebRTC?](#—á—Ç–æ-—Ç–∞–∫–æ–µ-webrtc)
2. [Peer-to-Peer (P2P)](#peer-to-peer-p2p)
3. [–ö–∞–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–≤—è–∑—å (Signaling)](#—Å–∏–≥–Ω–∞–ª–∏–Ω–≥)
4. [SDP (Session Description Protocol)](#sdp-session-description-protocol)
5. [ICE: –ü–æ–∏—Å–∫ –ø—É—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è](#ice-–ø–æ–∏—Å–∫-–ø—É—Ç–∏-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
6. [STUN –∏ TURN —Å–µ—Ä–≤–µ—Ä—ã](#stun-–∏-turn)
7. [PeerConnection API](#peerconnection-api)
8. [DataChannel: P2P –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö](#datachannel-p2p-–ø–µ—Ä–µ–¥–∞—á–∞-–¥–∞–Ω–Ω—ã—Ö)
9. [MediaStream –∏ Codecs](#mediastream-–∏-codecs)
10. [Connection States](#connection-states)
11. [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π-–ø—Ä–∏–º–µ—Ä)

---

## ‚ùì –ß—Ç–æ —Ç–∞–∫–æ–µ WebRTC?

**WebRTC (Web Real-Time Communication)** ‚Äî —ç—Ç–æ –Ω–∞–±–æ—Ä –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –±—Ä–∞—É–∑–µ—Ä–∞–º –∏ –º–æ–±–∏–ª—å–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å **–∞—É–¥–∏–æ, –≤–∏–¥–µ–æ –∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –¥—Ä—É–≥ –¥—Ä—É–≥—É** (peer-to-peer) –±–µ–∑ —É—á–∞—Å—Ç–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –≤ –ø–µ—Ä–µ–¥–∞—á–µ –º–µ–¥–∏–∞. üé•üí¨

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **getUserMedia**: –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
- **RTCPeerConnection**: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **RTCDataChannel**: –ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö P2P

### –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:

- Zoom, Google Meet, Discord (web-–≤–µ—Ä—Å–∏–∏)
- –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ –∏–≥—Ä—ã (P2P –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä)
- Telemed (–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)
- Screensharing –∏ —É–¥–∞–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

> [!NOTE]
> WebRTC —Ä–∞–±–æ—Ç–∞–µ—Ç **–≤ –±—Ä–∞—É–∑–µ—Ä–µ** –±–µ–∑ –ø–ª–∞–≥–∏–Ω–æ–≤! –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö (Chrome, Firefox, Safari, Edge).

---

## ü§ù Peer-to-Peer (P2P)

–í –æ–±—ã—á–Ω–æ–π –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã–µ –∏–¥—É—Ç:

```
–ö–ª–∏–µ–Ω—Ç A ‚Üí –°–µ—Ä–≤–µ—Ä ‚Üí –ö–ª–∏–µ–Ω—Ç B
```

–í WebRTC –¥–∞–Ω–Ω—ã–µ –∏–¥—É—Ç **–Ω–∞–ø—Ä—è–º—É—é**:

```
–ö–ª–∏–µ–Ω—Ç A ‚ü∑ –ö–ª–∏–µ–Ω—Ç B
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ P2P:

‚úÖ **–ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: –ù–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –º–µ–¥–∏–∞  
‚úÖ **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å**: –î–∞–Ω–Ω—ã–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä (end-to-end)

### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:

‚ùå **NAT traversal**: –ù—É–∂–Ω—ã STUN/TURN —Å–µ—Ä–≤–µ—Ä—ã  
‚ùå **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –¢—Ä–µ–±—É–µ—Ç—Å—è signaling —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è  
‚ùå **–ö–∞—á–µ—Å—Ç–≤–æ**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ–±–æ–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

```mermaid
flowchart LR
    subgraph Traditional["–ö–ª–∏–µ–Ω—Ç-–°–µ—Ä–≤–µ—Ä"]
        CA[Client A] -->|Upload| S[Server]
        S -->|Download| CB[Client B]
    end

    subgraph P2P["WebRTC P2P"]
        PA[Client A] <-->|Direct Stream| PB[Client B]
    end
```

---

## üó∫Ô∏è –ö–∞–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–≤—è–∑—å (Signaling)

–•–æ—Ç—è **–º–µ–¥–∏–∞** –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, –∫–ª–∏–µ–Ω—Ç–∞–º –Ω—É–∂–µ–Ω **signaling server** –¥–ª—è –æ–±–º–µ–Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (SDP, ICE candidates).

> [!IMPORTANT]
> **Signaling –ù–ï —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω** –≤ WebRTC! –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebSocket, HTTP long polling, Socket.IO –∏ —Ç.–¥.

```mermaid
sequenceDiagram
    participant A as Peer A (Caller)
    participant Sig as Signaling Server
    participant B as Peer B (Callee)

    Note over A: 1. –°–æ–∑–¥–∞–µ—Ç offer
    A->>Sig: SDP Offer
    Sig->>B: SDP Offer

    Note over B: 2. –°–æ–∑–¥–∞–µ—Ç answer
    B->>Sig: SDP Answer
    Sig->>A: SDP Answer

    Note over A,B: 3. –û–±–º–µ–Ω ICE candidates
    A->>Sig: ICE Candidate
    Sig->>B: ICE Candidate
    B->>Sig: ICE Candidate
    Sig->>A: ICE Candidate

    Note over A,B: 4. P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!
    A--)B: Media Stream (UDP)
```

---

## üìã SDP (Session Description Protocol)

**SDP** ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Å—Å–∏–∏:

- –ö–∞–∫–∏–µ –∫–æ–¥–µ–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è (VP8, H.264, Opus)
- IP –∞–¥—Ä–µ—Å–∞ –∏ –ø–æ—Ä—Ç—ã
- –¢–∏–ø—ã –º–µ–¥–∏–∞ (audio, video, data)
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (DTLS, SRTP)

### –ü—Ä–∏–º–µ—Ä SDP Offer:

```
v=0
o=- 4611731400430051336 2 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS stream

m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=ice-ufrag:xyz123
a=ice-pwd:abc456def789
a=fingerprint:sha-256 AA:BB:CC:DD:...
a=rtpmap:111 opus/48000/2
a=rtpmap:103 ISAC/16000

m=video 9 UDP/TLS/RTP/SAVPF 96 97
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=rtpmap:96 VP8/90000
a=rtpmap:97 H264/90000
a=fmtp:97 profile-level-id=42e01f
```

### Offer/Answer –º–æ–¥–µ–ª—å:

```javascript
// Peer A —Å–æ–∑–¥–∞–µ—Ç offer
const offer = await peerConnection.createOffer();
await peerConnection.setLocalDescription(offer);

// –û—Ç–ø—Ä–∞–≤–∫–∞ offer —á–µ—Ä–µ–∑ signaling
signalingChannel.send({ type: "offer", sdp: offer });

// Peer B –ø–æ–ª—É—á–∞–µ—Ç offer –∏ —Å–æ–∑–¥–∞–µ—Ç answer
await peerConnection.setRemoteDescription(offer);
const answer = await peerConnection.createAnswer();
await peerConnection.setLocalDescription(answer);

// –û—Ç–ø—Ä–∞–≤–∫–∞ answer –æ–±—Ä–∞—Ç–Ω–æ
signalingChannel.send({ type: "answer", sdp: answer });

// Peer A –ø–æ–ª—É—á–∞–µ—Ç answer
await peerConnection.setRemoteDescription(answer);
```

> [!TIP]
> **SDP Munging** ‚Äî —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SDP –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–µ–∫–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∏—Ç—Ä–µ–π—Ç–∞. –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è!

---

## üßä ICE: –ü–æ–∏—Å–∫ –ø—É—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

**ICE (Interactive Connectivity Establishment)** ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—É—á—à–µ–≥–æ –ø—É—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –ø–∏—Ä–∞–º–∏.

### –¢–∏–ø—ã ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:

1. **Host candidate** (–ª–æ–∫–∞–ª—å–Ω—ã–π IP)

   ```
   192.168.1.5:54321
   ```

   –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.

2. **Server Reflexive candidate** (–ø—É–±–ª–∏—á–Ω—ã–π IP —á–µ—Ä–µ–∑ STUN)

   ```
   203.0.113.5:54321
   ```

   –ü–æ–ª—É—á–µ–Ω –æ—Ç STUN —Å–µ—Ä–≤–µ—Ä–∞. –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ NAT.

3. **Relay candidate** (—á–µ—Ä–µ–∑ TURN —Å–µ—Ä–≤–µ—Ä)
   ```
   turn.example.com:3478
   ```
   –ú–µ–¥–∏–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ TURN —Å–µ—Ä–≤–µ—Ä. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ P2P –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:

```
Host > Server Reflexive > Relay
(–±—ã—Å—Ç—Ä–µ–µ)              (–º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ)
```

```mermaid
flowchart TD
    Start[–°—Ç–∞—Ä—Ç ICE] --> Host{Host candidate works?}
    Host -->|Yes| DirectP2P[Direct P2P]
    Host -->|No| STUN{STUN candidate works?}
    STUN -->|Yes| P2PThroughNAT[P2P —á–µ—Ä–µ–∑ NAT]
    STUN -->|No| TURN[Relay —á–µ—Ä–µ–∑ TURN]

    DirectP2P --> Success[–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ]
    P2PThroughNAT --> Success
    TURN --> Success
```

### –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ICE:

```javascript
peerConnection.onicecandidate = (event) => {
  if (event.candidate) {
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –¥—Ä—É–≥–æ–º—É –ø–∏—Ä—É
    signalingChannel.send({
      type: "ice-candidate",
      candidate: event.candidate,
    });
  } else {
    console.log("ICE gathering completed");
  }
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–∏—Ä–∞
signalingChannel.onmessage = async (message) => {
  if (message.type === "ice-candidate") {
    await peerConnection.addIceCandidate(message.candidate);
  }
};
```

---

## üß± STUN –∏ TURN —Å–µ—Ä–≤–µ—Ä—ã

### STUN (Session Traversal Utilities for NAT)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–º–æ–≥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É —É–∑–Ω–∞—Ç—å —Å–≤–æ–π **–ø—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å** –∏ –ø–æ—Ä—Ç.

```javascript
const configuration = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "stun:stun.example.com:3478" },
  ],
};

const pc = new RTCPeerConnection(configuration);
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ STUN —Å–µ—Ä–≤–µ—Ä
2. STUN —Å–µ—Ä–≤–µ—Ä –≤–∏–¥–∏—Ç –∑–∞–ø—Ä–æ—Å —Å IP `203.0.113.5:54321` (–≤–Ω–µ—à–Ω–∏–π IP NAT)
3. STUN –æ—Ç–≤–µ—á–∞–µ—Ç: "–Ø –≤–∏–∂—É —Ç–µ–±—è –∫–∞–∫ `203.0.113.5:54321`"
4. –ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç IP –∫–∞–∫ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ**: –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è **Symmetric NAT** (—Å—Ç—Ä–æ–≥–∏–π firewall).

---

### TURN (Traversal Using Relays around NAT)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö–æ–≥–¥–∞ P2P –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω, –º–µ–¥–∏–∞ **—Ä–µ—Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä**.

```javascript
const configuration = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    {
      urls: "turn:turn.example.com:3478",
      username: "user",
      credential: "password",
    },
  ],
};
```

**–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TURN**:

- –û–±–∞ –ø–∏—Ä–∞ –∑–∞ Symmetric NAT
- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ firewall –±–ª–æ–∫–∏—Ä—É—é—Ç UDP
- Proxy(Private Network) —Å —Å—Ç—Ä–æ–≥–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏

> [!WARNING]
> **TURN ‚Äî –¥–æ—Ä–æ–≥–æ!** –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –∏–¥–µ—Ç —á–µ—Ä–µ–∑ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.
>
> - –ù—É–∂–Ω–∞ –±–æ–ª—å—à–∞—è –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–ø—É—Å–∫–∞–Ω–∏—è
> - ~10-20% —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Ç—Ä–µ–±—É—é—Ç TURN
> - –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞—á–Ω—ã—Ö TURN (Twilio, Agora)

```mermaid
sequenceDiagram
    participant A as Peer A
    participant STUN as STUN Server
    participant TURN as TURN Server
    participant B as Peer B

    A->>STUN: –ö–∞–∫–æ–π –º–æ–π IP?
    STUN->>A: 203.0.113.5:54321

    Note over A,B: –ü–æ–ø—ã—Ç–∫–∞ P2P...
    A--xB: –ù–µ —É–¥–∞–ª–æ—Å—å (Symmetric NAT)

    Note over A,TURN: Fallback –Ω–∞ TURN
    A->>TURN: –í—ã–¥–µ–ª–∏—Ç—å relay
    TURN->>A: OK, –∏—Å–ø–æ–ª—å–∑—É–π turn:3478

    A->>TURN: Media Stream
    TURN->>B: Media Stream
    B->>TURN: Media Stream
    TURN->>A: Media Stream
```

---

## üîå PeerConnection API

`RTCPeerConnection` ‚Äî –≥–ª–∞–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç WebRTC –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º.

### –û—Å–Ω–æ–≤–Ω–æ–π workflow:

```javascript
// 1. –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection
const pc = new RTCPeerConnection({
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
});

// 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–µ–¥–∏–∞
const stream = await navigator.mediaDevices.getUserMedia({
  video: true,
  audio: true,
});

stream.getTracks().forEach((track) => {
  pc.addTrack(track, stream);
});

// 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –º–µ–¥–∏–∞
pc.ontrack = (event) => {
  const remoteVideo = document.getElementById("remoteVideo");
  remoteVideo.srcObject = event.streams[0];
};

// 4. ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
pc.onicecandidate = (event) => {
  if (event.candidate) {
    signalingChannel.send({
      type: "ice-candidate",
      candidate: event.candidate,
    });
  }
};

// 5. –°–æ–∑–¥–∞–Ω–∏–µ offer
const offer = await pc.createOffer();
await pc.setLocalDescription(offer);
signalingChannel.send({ type: "offer", sdp: offer });
```

---

## üì° DataChannel: P2P –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö

`RTCDataChannel` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –ø–∏—Ä–∞–º–∏ (–Ω–µ —Ç–æ–ª—å–∫–æ –º–µ–¥–∏–∞).

### –°–æ–∑–¥–∞–Ω–∏–µ DataChannel:

```javascript
// Peer A —Å–æ–∑–¥–∞–µ—Ç –∫–∞–Ω–∞–ª
const dataChannel = pc.createDataChannel("chat", {
  ordered: true, // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
  maxRetransmits: 3, // –ú–∞–∫—Å. –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
});

dataChannel.onopen = () => {
  console.log("DataChannel opened");
  dataChannel.send("Hello, Peer B!");
};

dataChannel.onmessage = (event) => {
  console.log("Received:", event.data);
};
```

```javascript
// Peer B –ø–æ–ª—É—á–∞–µ—Ç –∫–∞–Ω–∞–ª
pc.ondatachannel = (event) => {
  const dataChannel = event.channel;

  dataChannel.onmessage = (event) => {
    console.log("Received:", event.data);

    // Echo back
    dataChannel.send(`Echo: ${event.data}`);
  };
};
```

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö:

```javascript
// –¢–µ–∫—Å—Ç
dataChannel.send("Hello");

// Blob (—Ñ–∞–π–ª—ã)
const blob = new Blob(["file content"], { type: "text/plain" });
dataChannel.send(blob);

// ArrayBuffer (–±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
const buffer = new Uint8Array([1, 2, 3, 4]);
dataChannel.send(buffer);
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:

```javascript
// –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (–∫–∞–∫ TCP)
const reliable = pc.createDataChannel("reliable", {
  ordered: true,
  maxRetransmits: null, // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—ã
});

// –ù–µ–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (–∫–∞–∫ UDP, –¥–ª—è –∏–≥—Ä)
const unreliable = pc.createDataChannel("unreliable", {
  ordered: false,
  maxRetransmits: 0, // –ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
});
```

**Use cases**:

- –ß–∞—Ç—ã (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
- –ü–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤ P2P
- –û–Ω–ª–∞–π–Ω –∏–≥—Ä—ã (–ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–æ–≤)
- –ö–æ–ª–ª–∞–±–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üé¨ MediaStream –∏ Codecs

### –ó–∞—Ö–≤–∞—Ç –º–µ–¥–∏–∞:

```javascript
// –ö–∞–º–µ—Ä–∞ + –º–∏–∫—Ä–æ—Ñ–æ–Ω
const stream = await navigator.mediaDevices.getUserMedia({
  video: {
    width: { ideal: 1920 },
    height: { ideal: 1080 },
    frameRate: { ideal: 30 },
  },
  audio: {
    echoCancellation: true,
    noiseSuppression: true,
    autoGainControl: true,
  },
});

// –°–∫—Ä–∏–Ω—à–µ—Ä–∏–Ω–≥
const screenStream = await navigator.mediaDevices.getDisplayMedia({
  video: { cursor: "always" },
  audio: true, // –ó–≤—É–∫ —Å–∏—Å—Ç–µ–º—ã
});
```

### –ö–æ–¥–µ–∫–∏:

| –¢–∏–ø       | –ö–æ–¥–µ–∫ | –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞                           |
| :-------- | :---- | :--------------------------------------- |
| **–ê—É–¥–∏–æ** | Opus  | –õ—É—á—à–∏–π –¥–ª—è –≥–æ–ª–æ—Å–∞, –Ω–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞       |
| **–ê—É–¥–∏–æ** | G.711 | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π, —à–∏—Ä–æ–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å        |
| **–í–∏–¥–µ–æ** | VP8   | –û—Ç–∫—Ä—ã—Ç—ã–π, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ               |
| **–í–∏–¥–µ–æ** | VP9   | –õ—É—á—à–µ VP8, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ CPU         |
| **–í–∏–¥–µ–æ** | H.264 | –°—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∏, –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ |
| **–í–∏–¥–µ–æ** | AV1   | –ù–æ–≤–µ–π—à–∏–π, –ª—É—á—à–µ–µ —Å–∂–∞—Ç–∏–µ, –º–µ–¥–ª–µ–Ω–Ω—ã–π       |

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏—Ç—Ä–µ–π—Ç–æ–º:

```javascript
const sender = pc.getSenders().find((s) => s.track.kind === "video");

const parameters = sender.getParameters();
if (!parameters.encodings) {
  parameters.encodings = [{}];
}

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±–∏—Ç—Ä–µ–π—Ç–∞ –¥–æ 500 kbps
parameters.encodings[0].maxBitrate = 500_000;

await sender.setParameters(parameters);
```

---

## üö¶ Connection States

WebRTC –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ state –º–∞—à–∏–Ω:

### ICE Connection State:

```javascript
pc.oniceconnectionstatechange = () => {
  console.log("ICE State:", pc.iceConnectionState);
};
```

| State          | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| :------------- | :------------------------------- |
| `new`          | –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ              |
| `checking`     | –ü—Ä–æ–≤–µ—Ä–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤          |
| `connected`    | –•–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç   |
| `completed`    | –í—Å–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã          |
| `failed`       | –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ |
| `disconnected` | –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏           |
| `closed`       | –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ               |

### Connection State:

```javascript
pc.onconnectionstatechange = () => {
  console.log("Connection State:", pc.connectionState);

  if (pc.connectionState === "failed") {
    // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    pc.restartIce();
  }
};
```

---

## üíª –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä

### –ü—Ä–æ—Å—Ç–æ–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫:

```html
<!DOCTYPE html>
<html>
  <body>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <button onclick="startCall()">Start Call</button>

    <script>
      let pc;
      let localStream;

      async function startCall() {
        // 1. –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });

        document.getElementById("localVideo").srcObject = localStream;

        // 2. –°–æ–∑–¥–∞–µ–º PeerConnection
        pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        // 3. –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
        localStream.getTracks().forEach((track) => {
          pc.addTrack(track, localStream);
        });

        // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –º–µ–¥–∏–∞
        pc.ontrack = (event) => {
          document.getElementById("remoteVideo").srcObject = event.streams[0];
        };

        // 5. ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ signaling
            sendToSignaling({
              type: "ice-candidate",
              candidate: event.candidate,
            });
          }
        };

        // 6. –°–æ–∑–¥–∞–µ–º offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer —á–µ—Ä–µ–∑ signaling
        sendToSignaling({
          type: "offer",
          sdp: offer,
        });
      }

      // Signaling (—É–ø—Ä–æ—â–µ–Ω–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ WebSocket –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏)
      function sendToSignaling(message) {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WebSocket/HTTP
        socket.send(JSON.stringify(message));
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç signaling
      socket.onmessage = async (event) => {
        const message = JSON.parse(event.data);

        if (message.type === "offer") {
          await pc.setRemoteDescription(message.sdp);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          sendToSignaling({ type: "answer", sdp: answer });
        } else if (message.type === "answer") {
          await pc.setRemoteDescription(message.sdp);
        } else if (message.type === "ice-candidate") {
          await pc.addIceCandidate(message.candidate);
        }
      };
    </script>
  </body>
</html>
```

---

## üéØ Best Practices

> [!IMPORTANT]
> **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
>
> 1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS** ‚Äî `getUserMedia` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTPS
> 2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –±–∏—Ç—Ä–µ–π—Ç** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–∂–∞–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏ –ø–ª–æ—Ö–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
> 3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ TURN —Å–µ—Ä–≤–µ—Ä** ‚Äî ~10-20% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ —Å–º–æ–≥—É—Ç —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –±–µ–∑ –Ω–µ–≥–æ
> 4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `getStats()` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è packet loss, jitter
> 5. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** ‚Äî —Å–µ—Ç—å –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø–∞–¥–∞—Ç—å
>
> WebRTC —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É **UDP**, –∞ –Ω–µ TCP. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –µ—Å–ª–∏ –ø–∞—Ä–∞ –∫–∞–¥—Ä–æ–≤ –≤–∏–¥–µ–æ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è ‚Äî –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ, –∑–∞—Ç–æ —Å–≤—è–∑—å –±—É–¥–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π, –±–µ–∑ "–∑–∞–∏–∫–∞–Ω–∏–π" –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤. ‚ö°

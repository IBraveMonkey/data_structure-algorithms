package main

import (
	"fmt"
)

/*
 * Паттерн Tee-channel используется для разделения одного входящего канала
 * на два (или более) выходящих канала. Это похоже на тройник в сантехнике:
 * данные из одного источника дублируются в несколько независимых потоков.
 * Важно: чтение из выходящих каналов должно происходить параллельно,
 * иначе блокировка одного канала заблокирует весь поток.
 */

// tee разделяет один входящий канал на два выходящих
func tee(done <-chan interface{}, in <-chan interface{}) (<-chan interface{}, <-chan interface{}) {
	// Создаем два выходных канала
	out1 := make(chan interface{})
	out2 := make(chan interface{})

	// Запускаем горутину для дублирования данных
	go func() {
		defer close(out1) // Закрываем первый канал при выходе
		defer close(out2) // Закрываем второй канал при выходе

		// Читаем значения из входного канала
		for val := range in {
			// Создаем локальные копии каналов для безопасной итерации
			var out1, out2 = out1, out2

			// Отправляем значение в оба канала (нужно отправить дважды)
			for i := 0; i < 2; i++ {
				select {
				case <-done:
					// Получен сигнал завершения, выходим
					return
				case out1 <- val:
					// Успешно отправили в первый канал
					out1 = nil // Обнуляем, чтобы не слать повторно в эту итерацию
				case out2 <- val:
					// Успешно отправили во второй канал
					out2 = nil // Обнуляем, чтобы не слать повторно в эту итерацию
				}
			}
		}
	}()

	// Возвращаем оба канала только для чтения
	return out1, out2
}

func main() {
	// Создаем канал для сигнала завершения
	done := make(chan interface{})
	defer close(done)

	// Создаем входной канал
	in := make(chan interface{})

	// Горутина для генерации данных во входной канал
	go func() {
		defer close(in) // Закрываем канал после отправки всех данных
		for i := 1; i <= 5; i++ {
			in <- i // Отправляем числа от 1 до 5
		}
	}()

	// Разделяем входной канал на два выходных
	out1, out2 := tee(done, in)

	// Читаем из двух каналов одновременно (важно!)
	for val1 := range out1 {
		fmt.Printf("Поток 1 получил: %v\n", val1)
		fmt.Printf("Поток 2 получил: %v\n", <-out2) // Читаем из второго канала
	}
}
